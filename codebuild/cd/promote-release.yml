version: 0.2
# this buildspec assumes the aws-common-runtime/ubuntu-16.04 image
# This job is responsible for downloading the RC nupkgs and publishing them as the lastest release
phases:
  install:
    commands:
      # .NET Core install instructions taken from: https://dotnet.microsoft.com/download/linux-package-manager/ubuntu16-04/sdk-current
      - curl -L https://packages.microsoft.com/config/ubuntu/16.04/packages-microsoft-prod.deb --output /tmp/packages-microsoft-prod.deb
      - sudo dpkg -i /tmp/packages-microsoft-prod.deb
      - sudo apt-get install apt-transport-https
      - sudo apt-get update -y
      - sudo apt-get install dotnet-sdk-2.2 -y
      # need latest awscli for secretsmanager
      - sudo pip3 install awscli --upgrade

  pre_build:
    commands:
      - cd $CODEBUILD_SRC_DIR/aws-crt-dotnet
      - export PKG_VERSION=$(git describe --tags | cut -f1 -d'-' | cut -f2 -dv)
      - echo PKG_VERSION=$PKG_VERSION
      # pull nuget key
      - NUGET_KEY=$(aws secretsmanager get-secret-value --secret-id "NuGet/push" --query SecretString | cut -f2 -d\")
  build:
    commands:
      - mkdir -p /tmp/packages
      - cd /tmp/packages
      - curl -sLO https://api.nuget.org/v3-flatcontainer/awscrt/awscrt.${CRT_VERSION}-rc.nupkg -o AWSCRT.${PKG_VERSION}.nupkg
      - curl -sLO https://api.nuget.org/v3-flatcontainer/awscrt-http/awscrt-http.${CRT_VERSION}-rc.nupkg -o AWSCRT-HTTP.${PKG_VERSION}.nupkg
      - ls -l
      - dotnet nuget push AWSCRT.${PKG_VERSION}.nupkg -k $NUGET_KEY -s https://api.nuget.org/v3/index.json
      - dotnet nuget push AWSCRT-HTTP.${PKG_VERSION}.nupkg -k $NUGET_KEY -s https://api.nuget.org/v3/index.json
  
artifacts:
  discard-paths: yes
  files:
    - /tmp/packages/*.nupkg
